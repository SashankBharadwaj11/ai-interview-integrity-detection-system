<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Session {{ session.session_id }}</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 20px;
      background: #f7f7f9;
    }
    h1, h2, h3 { margin-bottom: 0.4em; }
    .section { margin-bottom: 2em; }
    .card-row { display: flex; flex-wrap: wrap; gap: 12px; }
    .card {
      background: #fff;
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      min-width: 180px;
      flex: 1;
    }
    .card-title {
      font-size: 12px;
      text-transform: uppercase;
      color: #666;
      margin-bottom: 4px;
    }
    .card-value { font-size: 18px; font-weight: 600; }

    .tag {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
    }
    .tag-low    { background: #e3f9e5; color: #1e7e34; }
    .tag-medium { background: #fff3cd; color: #856404; }
    .tag-high   { background: #f8d7da; color: #721c24; }

    table { border-collapse: collapse; width: 100%; background: #fff; }
    th, td {
      border: 1px solid #e0e0e0;
      padding: 6px 8px;
      font-size: 13px;
      vertical-align: top;
    }
    th { background-color: #fafafa; text-align: left; }

    pre { white-space: pre-wrap; margin: 0; font-size: 12px; }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #eee;
      color: #333;
    }
  </style>
</head>
<body>

  <!-- HEADER & SCORE -->
  <div class="section">
    <h1>Session {{ session.session_id }}</h1>
    <p>
      Duration: {{ '%.1f' % session.duration_seconds }} seconds
      ({{ '%.1f' % (session.duration_seconds / 60.0) }} min)<br>
      Frames: {{ session.num_frames }} (FPS: {{ '%.1f' % session.fps }})
    </p>

    {% if session.annotated_video_path %}
      <p>
        <strong>Annotated video:</strong>
        <code>{{ session.annotated_video_path }}</code>
      </p>
    {% endif %}

    {% set overall = scores.get('overall', None) %}
    {% set video_score = scores.get('video', None) %}
    {% set audio_score = scores.get('audio', None) %}

    {% if overall is not none %}
      {% if overall >= 80 %}
        {% set risk_tag = 'Low risk' %}
        {% set risk_class = 'tag tag-low' %}
      {% elif overall >= 60 %}
        {% set risk_tag = 'Medium risk' %}
        {% set risk_class = 'tag tag-medium' %}
      {% else %}
        {% set risk_tag = 'High risk' %}
        {% set risk_class = 'tag tag-high' %}
      {% endif %}

      <h2>
        Integrity score:
        {{ '%.0f' % overall }}/100
        <span class="{{ risk_class }}">{{ risk_tag }}</span>
      </h2>
    {% endif %}
  </div>

  <!-- KEY METRICS -->
  <div class="section">
    <h2>Summary</h2>

    {% set total_alerts = summary.get('total_alerts', alerts|length) %}
    {% set alerts_per_minute = summary.get('alerts_per_minute', 0.0) %}
    {% set by_type = summary.get('by_type', {}) %}

    <div class="card-row">
      <div class="card">
        <div class="card-title">Total alerts</div>
        <div class="card-value">{{ total_alerts }}</div>
      </div>
      <div class="card">
        <div class="card-title">Alerts per minute</div>
        <div class="card-value">{{ '%.1f' % alerts_per_minute }}</div>
      </div>
      {% if video_score is not none %}
      <div class="card">
        <div class="card-title">Video integrity</div>
        <div class="card-value">{{ '%.0f' % video_score }}/100</div>
      </div>
      {% endif %}
      {% if audio_score is not none %}
      <div class="card">
        <div class="card-title">Audio integrity</div>
        <div class="card-value">{{ '%.0f' % audio_score }}/100</div>
      </div>
      {% endif %}
      {% if by_type %}
      <div class="card">
        <div class="card-title">Most frequent alert</div>
        {% set top_type = (by_type|dictsort(true, 'value'))[0][0] %}
        {% set top_count = (by_type|dictsort(true, 'value'))[0][1] %}
        <div class="card-value">{{ top_type }} ({{ top_count }})</div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- CHARTS -->
  <div class="section">
    <h2>Visual overview</h2>
    <div style="display:flex; flex-wrap:wrap; gap:20px;">
      <div style="flex:1; min-width:260px;">
        <h3>Alerts by type</h3>
        <canvas id="alertsByTypeChart"></canvas>
      </div>
      <div style="flex:1; min-width:260px;">
        <h3>Alerts over time</h3>
        <canvas id="alertsTimelineChart"></canvas>
      </div>
    </div>
  </div>

  <!-- AUDIO ANALYSIS -->
<div class="section">
  <h2>Audio analysis</h2>

  {# Case 1: full audio summary dict from speaker consistency module #}
  {% if audio is mapping and 'speaker_consistency_score' in audio %}
    <p>Speaker consistency score (0–1): {{ '%.3f' % audio.speaker_consistency_score }}</p>
    <p>Average similarity: {{ '%.3f' % audio.avg_similarity }}</p>
    <p>Minimum similarity: {{ '%.3f' % audio.min_similarity }}</p>
    <p>
      Speaker change flag:
      {% if audio.speaker_change_flag %}<strong>Yes</strong>{% else %}No{% endif %}
      (threshold: {{ '%.2f' % audio.similarity_threshold }})
    </p>
    <p>Chunks analyzed: {{ audio.num_chunks }}</p>

    {# Optional: speaker similarity chart #}
    {% if audio.chunk_similarities is defined %}
      <h3>Speaker similarity over time</h3>
      <canvas id="speakerSimilarityChart"></canvas>
    {% endif %}

  {# Case 2: audio is already a numeric score (0–100) #}
  {% elif audio is number %}
    <p>Audio integrity score: {{ '%.1f' % audio }} / 100</p>
    <p>(No detailed speaker breakdown available for this session.)</p>

  {# Case 3: audio is a dict with an error field or generic message #}
  {% elif audio is mapping and 'error' in audio %}
    <p>Audio analysis error: {{ audio.error }}</p>

  {# Fallback #}
  {% else %}
    <p>No audio analysis available for this session.</p>
  {% endif %}
</div>


  <!-- DETAILED EVENTS -->
  <div class="section">
    <h2>Alert timeline (detailed)</h2>
    {% if alerts %}
      <table>
        <tr>
          <th>Time (s)</th>
          <th>Type</th>
          <th>Severity</th>
          <th>Details</th>
        </tr>
        {% for a in alerts %}
          <tr>
            <td>{{ '%.2f' % a.timestamp }}</td>
            <td>{{ a.type }}</td>
            <td>
              {% set sev = (a.severity or 'medium')|lower %}
              {% if sev == 'high' or sev == 'critical' %}
                <span class="tag tag-high">{{ a.severity }}</span>
              {% elif sev == 'low' or sev == 'info' %}
                <span class="tag tag-low">{{ a.severity }}</span>
              {% else %}
                <span class="tag tag-medium">{{ a.severity }}</span>
              {% endif %}
            </td>
            <td>
              {% if a.type == 'OBJECT_DETECTED' and a.details %}
                {{ a.details.label }} ({{ '%.2f' % a.details.confidence }})
              {% elif a.type == 'GAZE_AWAY' and a.details %}
                Gaze: {{ a.details.direction }},
                EAR: {{ '%.3f' % a.details.eye_ratio }},
                Dur: {{ '%.1f' % a.details.duration_sec }} s
              {% elif a.type == 'FACE_MISSING' and a.details %}
                Face missing for {{ '%.1f' % a.details.duration_sec }} s
              {% elif a.type == 'MULTI_FACE' and a.details %}
                {{ a.details.num_faces }} faces detected
              {% elif a.type == 'MOUTH_MOVEMENT' and a.details %}
                {{ a.details.note }}
              {% elif a.details %}
                <pre>{{ a.details | tojson(indent=2) }}</pre>
              {% else %}
                &mdash;
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <p>No alerts recorded for this session.</p>
    {% endif %}
  </div>

  <!-- DATA TO JS VIA DATA-* -->
  <div id="session-data"
      data-by-type='{{ by_type | tojson | safe }}'
      data-alerts='{{ alerts | tojson | safe }}'
      data-duration='{{ session.duration_seconds | tojson | safe }}'
      data-audio='{{ audio | tojson | safe }}'>
  </div>


  <!-- CHART JS LOGIC -->
  <script>
    const sessionDataEl = document.getElementById('session-data');

    const byType = JSON.parse(sessionDataEl.dataset.byType || '{}');
    const alertEvents = JSON.parse(sessionDataEl.dataset.alerts || '[]');
    const durationSec = JSON.parse(sessionDataEl.dataset.duration || '0');
    const audioData = JSON.parse(sessionDataEl.dataset.audio || '{}');

    // Speaker similarity chart (if we have chunk-level similarities)
    if (audioData && audioData.chunk_similarities) {
      const sims = audioData.chunk_similarities;
      const chunkSec = audioData.chunk_sec || 3;  // default 3s per chunk

      const labels = sims.map((_, i) => {
        const t = i * chunkSec;
        return (t / 60).toFixed(1) + ' min';
      });

      const canvas = document.getElementById('speakerSimilarityChart');
      if (canvas) {
        new Chart(canvas, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Similarity to reference chunk',
              data: sims
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                suggestedMin: 0.0,
                suggestedMax: 1.0
              }
            },
            plugins: {
              legend: { display: false }
            }
          }
        });
      }
    }

    // Bar chart: alerts by type
    const typeLabels = Object.keys(byType);
    const typeCounts = Object.values(byType);

    if (typeLabels.length > 0) {
      new Chart(
        document.getElementById('alertsByTypeChart'),
        {
          type: 'bar',
          data: {
            labels: typeLabels,
            datasets: [{
              label: 'Alerts',
              data: typeCounts
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
              y: { beginAtZero: true, ticks: { precision: 0 } }
            }
          }
        }
      );
    }

    // Line chart: alerts over time (1-minute buckets)
    if (alertEvents.length > 0) {
      const bucketSize = 60.0;
      const numBuckets = Math.max(1, Math.ceil(durationSec / bucketSize));
      const buckets = new Array(numBuckets).fill(0);

      alertEvents.forEach(a => {
        const idx = Math.min(numBuckets - 1, Math.floor(a.timestamp / bucketSize));
        buckets[idx] += 1;
      });

      const labels = [];
      for (let i = 0; i < numBuckets; i++) {
        const start = i * bucketSize;
        const end = Math.min(durationSec, (i + 1) * bucketSize);
        labels.push(`${(start / 60).toFixed(1)}–${(end / 60).toFixed(1)} min`);
      }

      new Chart(
        document.getElementById('alertsTimelineChart'),
        {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Alerts per minute',
              data: buckets
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
              y: { beginAtZero: true, ticks: { precision: 0 } }
            }
          }
        }
      );
    }
  </script>

</body>
</html>
